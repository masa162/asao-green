---
import BaseLayout from "../../layouts/BaseLayout.astro";
import HorizontalCard from "../../components/HorizontalCard.astro";
import { getCollection } from "astro:content";

// ğŸ“ 1. è¨˜äº‹ãƒ¡ã‚¿ã‚’å–å¾—ã— pubDate é™é †ã§ã‚½ãƒ¼ãƒˆ
const articles = (await getCollection("articles")).sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

// ğŸ–¼ï¸ 2. å„è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã® 001.* ã‚’é™çš„ importï¼ˆWebP ã‚‚å«ã‚€ï¼‰
const thumbs = import.meta.glob(
  "../../content/articles/*/001.{jpg,jpeg,png,webp}",
  { eager: true, import: "default" }
);
const thumbBySlug = Object.fromEntries(
  Object.entries(thumbs).map(([path, mod]) => [path.split("/").at(-2), mod])
);

// ğŸ› ï¸ 3. ã‚µãƒ ãƒã‚¤ãƒ«è§£æ±ºãƒ˜ãƒ«ãƒ‘ãƒ¼
function resolveImage(post, slug) {
  const img = post.data.image;

  // (1) ImageMetadata ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆimport å¤‰æ•°ï¼‰
  if (img && typeof img === "object") return img;

  // (2) çµ¶å¯¾ / å¤–éƒ¨ URL
  if (typeof img === "string" && (img.startsWith("/") || img.startsWith("http"))) {
    return img;
  }

  // (3) ç›¸å¯¾ãƒ‘ã‚¹æŒ‡å®š â†’ ãƒ•ã‚©ãƒ«ãƒ€å†… 001.* ã‚’å„ªå…ˆ
  if (typeof img === "string" && thumbBySlug[slug]) {
    return thumbBySlug[slug];
  }

  // (4) ã©ã‚Œã«ã‚‚è©²å½“ã—ãªã„å ´åˆã¯ã‚µã‚¤ãƒˆå…±é€š OGP
  return "/images/ogp/ogp.png";
}
---

<script type="module">
  const $ = (s) => document.querySelectorAll(s);
  document.getElementById("search")?.addEventListener("input", (e) => {
    const kw = e.target.value.toLowerCase();
    $(".article-card").forEach((c) =>
      (c.style.display = c.innerText.toLowerCase().includes(kw) ? "block" : "none")
    );
  });
</script>

<BaseLayout
  title="éº»ç”ŸåŒºã®è‡ªç„¶è¦³å¯Ÿä¸€è¦§ | ã‚ã•ãŠã¨ã¿ã©ã‚Š"
  description="ã‚ã•ãŠã¨ã¿ã©ã‚ŠãŒå³é¸ã—ãŸéº»ç”ŸåŒºã®è‡ªç„¶è¦³å¯Ÿã®è¨˜äº‹ä¸€è¦§ãƒšãƒ¼ã‚¸ã€‚"
  image="/images/ogp/ogp.png"
  url="https://asao-green.netlify.app/articles"
  sideBarActiveItemID="articles"
>
  <section class="max-w-4xl mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold mb-6">ğŸŒ¿ è¦³å¯Ÿè¨˜äº‹ä¸€è¦§</h1>

    <div class="mb-8">
      <input
        id="search"
        type="text"
        placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆä¾‹ï¼šæ¤ç‰©ã€éº»ç”Ÿå·ï¼‰"
        class="input input-bordered w-full"
      />
    </div>

    {articles.length === 0 ? (
      <p class="text-gray-500 dark:text-gray-400">è¨˜äº‹ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    ) : (
      <div class="space-y-6">
        {articles.map((post) => (
          <div class="article-card">
            <HorizontalCard
              title={post.data.title}
              desc={post.data.description}
              img={resolveImage(post, post.slug)}
              url={`/articles/${post.slug}`}
              badge="ã‚ã•ãŠã¨ã¿ã©ã‚Š"
              tags={post.data.tags}
              pubDate={post.data.pubDate}
            />
          </div>
        ))}
      </div>
    )}
  </section>
</BaseLayout>

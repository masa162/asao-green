---
import BaseLayout from "../layouts/BaseLayout.astro";
import HorizontalCard from "../components/HorizontalCard.astro";
import { getCollection } from "astro:content";
import Hero from "../components/Hero.astro";

// 1. è¨˜äº‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å–å¾— â†’ å…¬é–‹æ—¥é™é †
const posts = (await getCollection("articles")).sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
const recentPosts = posts.slice(0, 3);

// 2. å„è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã® 001.* ã‚’é™çš„ importï¼ˆWebP ã‚‚å¯¾å¿œï¼‰
const thumbs = import.meta.glob(
  "../content/articles/*/001.{jpg,jpeg,png,webp}",
  { eager: true, import: "default" }
);
const thumbBySlug = Object.fromEntries(
  Object.entries(thumbs).map(([path, mod]) => [path.split("/").at(-2), mod])
);

// 3. ã‚µãƒ ãƒã‚¤ãƒ«è§£æ±ºãƒ˜ãƒ«ãƒ‘ãƒ¼
function resolveImage(post) {
  const img = post.data.image;

  // (a) ImageMetadataï¼ˆimport å¤‰æ•°ï¼‰
  if (img && typeof img === "object") return img;

  // (b) çµ¶å¯¾ URL / ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹
  if (typeof img === "string" && (img.startsWith("/") || img.startsWith("http"))) {
    return img;
  }

  // (c) ç›¸å¯¾ãƒ‘ã‚¹ or æœªè¨­å®š â†’ ãƒ•ã‚©ãƒ«ãƒ€å†… 001.* ãŒã‚ã‚Œã°ä½¿ç”¨
  if (thumbBySlug[post.slug]) return thumbBySlug[post.slug];

  // (d) ã™ã¹ã¦ç„¡ã‘ã‚Œã°ã‚µã‚¤ãƒˆå…±é€š OGP
  return "/images/ogp/ogp.png";
}
---

<BaseLayout
  title="ã‚ã•ãŠã¨ã¿ã©ã‚Šï½œéº»ç”ŸåŒºã®è‡ªç„¶ã¨ãã‚‰ã—ã®è¨˜éŒ²"
  description="ã€ã‚ã•ãŠã¨ã¿ã©ã‚Šã€ã¯ã€å·å´å¸‚éº»ç”ŸåŒºã®è‡ªç„¶ã‚„æ¤ç‰©ã€å­£ç¯€ã®é¢¨æ™¯ã€åœ°åŸŸã®é­…åŠ›ã‚’ã‚„ã•ã—ãç´¹ä»‹ã™ã‚‹è¦³å¯Ÿï¼†è¨˜éŒ²ãƒ–ãƒ­ã‚°ã§ã™ã€‚"
  image="/images/ogp/ogp.png"
  url="https://asao-green.netlify.app/"
  sideBarActiveItemID="home"
>
  <Hero />

  <section class="pb-12 mt-5 text-center md:text-left">
    <h1 class="text-3xl font-bold mb-2">ã‚ˆã†ã“ãã€ã‚ã•ãŠã¨ã¿ã©ã‚Šã¸ ğŸŒ±</h1>
    <p class="text-lg mb-2">
      ã€ã‚ã•ãŠã¨ã¿ã©ã‚Šã€ã¯ã€å·å´å¸‚éº»ç”ŸåŒºã®è‡ªç„¶ã‚„æ¤ç‰©ã€å­£ç¯€ã®ã†ã¤ã‚ã„ã‚’<strong>ã‚„ã•ã—ãè¦³å¯Ÿãƒ»è¨˜éŒ²</strong>ã—ã¦ã„ããƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ­ã‚°ã§ã™ã€‚
    </p>
    <p class="text-lg">
      æ•£æ­©ã§è¦‹ã¤ã‘ãŸè‰èŠ±ã‚„å…¬åœ’ã®æ™¯è‰²ã€èº«è¿‘ãªç”Ÿãç‰©ãŸã¡ã®è¨˜éŒ²ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
    </p>
  </section>

  <section class="pb-12">
    <h2 class="text-2xl font-bold mb-4">ğŸ“° æ–°ç€è¨˜äº‹</h2>

    {recentPosts.length > 0 ? (
      <div class="flex flex-col gap-6">
        {recentPosts.map((post) => (
          <HorizontalCard
            title={post.data.title}
            desc={post.data.description}
            url={`/articles/${post.slug}`}
            img={resolveImage(post)}
            tags={post.data.tags}
            pubDate={post.data.pubDate}
            target="_self"
          />
        ))}
        <div class="mt-6 text-right">
          <a href="/articles" class="btn btn-outline btn-sm">ã‚‚ã£ã¨è¦‹ã‚‹ â†’</a>
        </div>
      </div>
    ) : (
      <p class="text-gray-500">è¨˜äº‹ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    )}
  </section>
</BaseLayout>
